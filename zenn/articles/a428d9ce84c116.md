---
title: "TensorFlowã®Dataset.mapã¨Dataset.shuffleã§ãƒ©ãƒ³ãƒ€ãƒ ãªè¦ç´ é †ã‚’å¯¾å¿œã•ã›ã‚‹"
emoji: "âš™ï¸"
type: "tech"
topics:
  - "python"
  - "tensorflow"
  - "ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ©ãƒ¼ãƒ‹ãƒ³ã‚°"
  - "æ©Ÿæ¢°å­¦ç¿’"
published: true
published_at: "2022-12-18 22:05"
---

## ã¯ã˜ã‚ã«
ä»¥å‰ã«TensorFlowã®Data APIã§ãƒ‡ãƒ¼ã‚¿ã‚’åŠ¹ç‡çš„ã«æµã—è¾¼ã‚ã‚‹ã¨çŸ¥ã‚Šã€Datasetã‚’ä½¿ã„å§‹ã‚ã¾ã—ãŸã€‚
ã¨ã“ã‚ãŒ`Dataset.map`ã§ã©ãƒãƒã‚Šã—ã€ä»Šå›4ãƒ¶æœˆè¶Šã—ã«åŸå› è§£æ˜ã§ããŸã®ã§ã€è¨˜äº‹ã‚’æ›¸ãã“ã¨ã«ã—ã¾ã—ãŸã€‚

:::message
ã“ã®è¨˜äº‹ã«ã¯ã€ä¸€éƒ¨ã‚¹ãƒãƒ¼ãƒˆã§ãªã„ï¼ˆå¯¾å‡¦ç™‚æ³•çš„ãªï¼‰è§£æ±ºç­–ãŒã‚ã‚Šã¾ã™ã€‚
è‰¯ã„è§£æ±ºç­–ãŒã‚ã‚‹æ–¹ã¯ã€ãœã²ã‚³ãƒ¡ãƒ³ãƒˆã«æ®‹ã—ã¦ã„ãŸã ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚
:::


## å•é¡Œã®ã‚³ãƒ¼ãƒ‰
ãƒ¢ãƒ‡ãƒ«ã«å…¥åŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã¨ãƒ©ãƒ™ãƒ«ã¨ã—ã¦å­¦ç¿’ã™ã‚‹ãŸã‚ã®å‡ºåŠ›ç”¨ãƒ‡ãƒ¼ã‚¿ãŒã‚¿ãƒ—ãƒ«ã«ãªã£ãŸãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚å…¥åŠ›ã¨å‡ºåŠ›ã¯ãã‚Œãã‚Œè¶³ã™ã¨10ã«ãªã‚‹æ•´æ•°ã§ã™ã€‚
```python
def func():
    """å’ŒãŒ10ã«ãªã‚‹å€¤ã®ã‚¿ãƒ—ãƒ«ã‚’è¿”ã™é–¢æ•°"""
    n = random.randint(0, 10)
    return n, 10 - n

def map_func(data):
    """mapã®ä¸­ã§ä»»æ„ã®Pythonã‚’æ›¸ããŸã‚ã®ãƒ©ãƒƒãƒ‘ãƒ¼"""
    return tf.py_function(func=func, inp=[], Tout=[tf.int32, tf.int32])

def create_dataset():
    """å…¥åŠ›ç”¨ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã¨å‡ºåŠ›ç”¨ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ä½œæˆ"""
    dataset = tf.data.Dataset.range(5)
    dataset = dataset.shuffle(buffer_size=5)
    dataset = dataset.map(map_func)
    return dataset
```
ä¸Šè¨˜ã¯ç°¡ç•¥åŒ–ã—ãŸã‚³ãƒ¼ãƒ‰ãªã®ã§ã€æœ¬æ¥ã¯å¿…è¦ãªã„`tf.py_function`ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
`inp`ã¯`func`ã«æ¸¡ã™å¼•æ•°ã§ã€`Tout`ã¯æˆ»ã‚Šå€¤ã®å‹ã§ã™ã€‚

`Dataset.map`ã§ã¯å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãªã©ã‚’ä½¿ãŠã†ã¨ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã‚Šã™ã‚‹ã®ã§ã™ãŒã€`tf.py_function`ã‚’ä½¿ã†ã“ã¨ã§å®Ÿè¡Œé€Ÿåº¦ã¨å¼•ãæ›ãˆã«è‡ªç”±ã«Pythonã‚’æ›¸ãã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã“ã“ã§å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã—ãŸã€‚

ãã‚Œã§ã¯ã€ä½œæˆã—ãŸãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ä¸­èº«ã‚’å‡ºåŠ›ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
```python
dataset = create_dataset()

# ã‚¿ãƒ—ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’å…¥åŠ›ã¨å‡ºåŠ›ã«åˆ†å‰²
x = dataset.map(lambda x, y: x)
y = dataset.map(lambda x, y: y)

for x, y in zip(x, y):
    print(x, y)
```
ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’åˆ†å‰²ã—ã¦`zip`ã«å…¥ã‚Œã‚‹ã®ã¯è»¢ç½®ã®ãŸã‚ã§ã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯`zip(*hoge)`ã¨å¤§ä½“åŒã˜ã§ã™ã€‚ã¤ã¾ã‚Šã€`[ãƒ‡ãƒ¼ã‚¿æ•°ï¼ˆ5ï¼‰, ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæ•°ï¼ˆ2ï¼‰]`ã®2æ¬¡å…ƒé…åˆ—ã‚’`[ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæ•°ï¼ˆ2ï¼‰, ãƒ‡ãƒ¼ã‚¿æ•°ï¼ˆ5ï¼‰]`ã«ç›´ã—ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚

å®Ÿè¡Œã™ã‚‹ã¨ã€ã“ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
```python
# tf.Tensor(2, shape=(), dtype=int32) tf.Tensor(6, shape=(), dtype=int32)
# tf.Tensor(0, shape=(), dtype=int32) tf.Tensor(9, shape=(), dtype=int32)
# tf.Tensor(1, shape=(), dtype=int32) tf.Tensor(7, shape=(), dtype=int32)
# tf.Tensor(4, shape=(), dtype=int32) tf.Tensor(9, shape=(), dtype=int32)
# tf.Tensor(3, shape=(), dtype=int32) tf.Tensor(10, shape=(), dtype=int32)
```
ã‚ã‚Œï¼Ÿå…¥åŠ›ã¨å‡ºåŠ›ã®å¯¾å¿œé–¢ä¿‚ãŒå´©ã‚Œã¦ã‚‹â€¦ï¼Ÿ
ã—ã‹ã‚‚å‡ºåŠ›ã«9ãŒ2ã¤ã‚ã‚‹ã—ã€‚`2 + 6`ã‚‚`0 + 9`ã‚‚ã€è¶³ã—ã¦10ã«ã¯ãªã‚‰ãªã„ãã€ã€

çµæœçš„ã«ã¯ã€`dataset.map` Ã— `random`ãŒçµ„ã¿åˆã‚ã•ã£ãŸã“ã¨ã§ãƒãƒã£ã¦ã„ã¾ã—ãŸã€‚ãã“ã«`dataset.shuffle`ã‚‚åŠ ã‚ã£ãŸã“ã¨ã§ã‚«ã‚ªã‚¹ãªçŠ¶æ…‹ã«ãªã‚Šã€è§£æ±ºã¾ã§ã‹ãªã‚Šã®æ™‚é–“ã‚’è¦ã—ã¦ã—ã¾ã„ã¾ã—ãŸã€‚

## åŸå›  1
ç›´æ¥çš„ãªåŸå› ã¯ã“ã‚Œã§ã™ã€‚2ã¤ã®`dataset`ã‚’ä½œæˆã—ãŸã“ã¨ã§ã€ãƒ©ãƒ³ãƒ€ãƒ å€¤ã‚’å–å¾—ã™ã‚‹éš›ã®seedãŒå¤‰ã‚ã£ã¦ã—ã¾ã£ãŸã“ã¨ãŒåŸå› ã§ã—ãŸã€‚
```python
x = dataset.map(lambda x, y: x)  # 1ã¤ç›®ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ
y = dataset.map(lambda x, y: y)  # 2ã¤ç›®ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ

for x, y in zip(x, y):
    print(x, y)
```

## è§£æ±ºæ–¹æ³• 1
ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’1ã¤ã«ã¾ã¨ã‚ã‚‹ã“ã¨ã§è§£æ±ºã§ãã¾ã™ã€‚
```python
for data in dataset:
    print(data)
```
ãŸã ä»Šå›ã¯ã€å®Ÿè£…ã®éƒ½åˆä¸Šã“ã®è§£æ±ºç­–ã¯é©ç”¨ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆä¸Šè¨˜ä»¥å¤–ã§ã‚‚è¤‡æ•°å›ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã£ãŸï¼‰ã€‚

ãªã®ã§ã“ã“ã‹ã‚‰ã¯ã€`dataset`ã‚’åˆ†ã‘ãŸã„äººã®ãŸã‚ã®è§£æ±ºæ–¹æ³•ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚

## è§£æ±ºæ–¹æ³• 2
æ®‹å¿µãªãŒã‚‰ã“ã“ãŒã‚¹ãƒãƒ¼ãƒˆã§ã¯ãªã„ã®ã§ã™ãŒã€ãƒ‡ãƒ¼ã‚¿ã”ã¨ã«seedã‚’å›ºå®šã™ã‚‹ã“ã¨ã§è§£æ±ºã§ãã¾ã™ã€‚
```python
def func(seed=None):
    random.seed(seed.numpy())  # seedã‚’è¨­å®š
    n = random.randint(0, 5)
    return n, 10 - n

def map_func(data):
    # funcã®seedã¨ã—ã¦dataï¼ˆæ•´æ•°ï¼‰ã‚’æ¸¡ã™
    return tf.py_function(func=func, inp=[data], Tout=[tf.int32, tf.int32])
```
ä¸Šè¨˜ã§ã¯å„ãƒ‡ãƒ¼ã‚¿ã«å›ºæœ‰ã®seedï¼ˆ`tf.data.Dataset.range`ã§ç”Ÿæˆã•ã‚ŒãŸæ•´æ•°ï¼‰ã‚’æ¸¡ã™ã“ã¨ã§ã€å‘¼ã³å‡ºã—ã”ã¨ã«å®Ÿè¡ŒçµæœãŒå¤‰ã‚ã‚‹ã®ã‚’é˜²ã„ã§ã„ã¾ã™ã€‚

å¯¾å‡¦ç™‚æ³•çš„ã§ã‚„ã‚„ãƒ€ã‚µã„ã§ã™ãŒã€æ±ç”¨çš„ã§ã¯ã‚ã‚Šã¾ã™ã€‚

## åŸå›  2
ä¸Šè¨˜ã®ä¿®æ­£ã§è§£æ±ºã—ãŸã‹ã¨æ€ã„ãã‚„ã€å®Ÿã¯ã¾ã åˆ¥ã®å•é¡ŒãŒæ®‹ã£ã¦ã„ã¾ã™ã€‚
ä¿®æ­£ã—ãŸã‚³ãƒ¼ãƒ‰ã®å®Ÿè¡Œçµæœã¯ã“ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
```python
# tf.Tensor(1, shape=(), dtype=int32) tf.Tensor(10, shape=(), dtype=int32)
# tf.Tensor(1, shape=(), dtype=int32) tf.Tensor(9, shape=(), dtype=int32)
# tf.Tensor(0, shape=(), dtype=int32) tf.Tensor(7, shape=(), dtype=int32)
# tf.Tensor(1, shape=(), dtype=int32) tf.Tensor(9, shape=(), dtype=int32)
# tf.Tensor(3, shape=(), dtype=int32) tf.Tensor(9, shape=(), dtype=int32)
```
å…¥åŠ›ã¨å‡ºåŠ›ã®å’Œã¯10ã«ãªã‚Šã¾ã›ã‚“ãŒã€é †ç•ªã‚’å…¥ã‚Œæ›¿ãˆã‚‹ã“ã¨ã§10ã«ãªã£ã¦ã„ã¾ã™ã€‚
å®Œå…¨ã«ãƒ©ãƒ³ãƒ€ãƒ ã«ãªã‚‹å•é¡Œã¯è§£æ±ºã—ã¾ã—ãŸãŒã€å¯¾å¿œé–¢ä¿‚ãŒå´©ã‚Œã¦ã„ã‚‹å•é¡Œã¯ã¾ã æœªè§£æ±ºã®ã¾ã¾ã§ã™ã­ã€‚

ã“ã‚Œã¯ã€`dataset`ã®ç”Ÿæˆã”ã¨ã«è¦ç´ é †ãŒã‚·ãƒ£ãƒƒãƒ•ãƒ«ã•ã‚Œã‚‹ã“ã¨ãŒåŸå› ã§ã™ã€‚

## è§£æ±ºæ–¹æ³• 2ï¼ˆç¶šãï¼‰
`dataset.shuffle`ã«`reshuffle_each_iteration=False`ã‚’æ¸¡ã™ã“ã¨ã§è§£æ±ºã§ãã¾ã™ã€‚
```python
def create_dataset():
    dataset = tf.data.Dataset.range(5)
    # å‘¼ã³å‡ºã—ã®ãŸã³ã«ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ãªã„ï¼ˆæœ€åˆã ã‘ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹ï¼‰
    dataset = dataset.shuffle(buffer_size=5, reshuffle_each_iteration=False)
    dataset = dataset.map(map_func)
    return dataset
```
ã“ã‚Œã§1å›ç›®ã®å‘¼ã³å‡ºã—ã§ã®ã¿è¦ç´ é †ãŒã‚·ãƒ£ãƒƒãƒ•ãƒ«ã•ã‚Œã€2å›ç›®ä»¥é™ã¯åŒã˜è¦ç´ é †ãŒä¿ãŸã‚Œã¾ã™ã€‚

ãã‚Œã§ã¯ã€ã‚‚ã†1åº¦å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼
```python
# tf.Tensor(1, shape=(), dtype=int32) tf.Tensor(9, shape=(), dtype=int32)
# tf.Tensor(1, shape=(), dtype=int32) tf.Tensor(9, shape=(), dtype=int32)
# tf.Tensor(0, shape=(), dtype=int32) tf.Tensor(10, shape=(), dtype=int32)
# tf.Tensor(1, shape=(), dtype=int32) tf.Tensor(9, shape=(), dtype=int32)
# tf.Tensor(3, shape=(), dtype=int32) tf.Tensor(7, shape=(), dtype=int32)
```
å…¥åŠ›ã¨å‡ºåŠ›ã®å’ŒãŒ10ã«ãªã‚Šã¾ã—ãŸ ğŸ‰ğŸ‰ğŸ‰
ã¡ã‚ƒã‚“ã¨ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚‚ã•ã‚Œã¦ã„ã¾ã™ã­ã€‚


## ãŠã‚ã‚Šã«
ä»Šå›ã¯`Dataset.map` Ã— `Dataset.shuffle` Ã— `random`ã¨3ã¤ã®è¦ç´ ãŒçµ¡ã¿åˆã£ãŸå•é¡Œã ã£ãŸã®ã§ã€è§£æ±ºã¾ã§æœ¬å½“ã«æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã—ãŸï¼ˆã¨ã„ã†ã‹å®Ÿè£…ã§ã¯ã‚‚ã£ã¨è¤‡é›‘ã ã£ãŸï¼‰ã€‚

å®Ÿéš›ã®å…¥å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿ã¯æ•°å€¤ã§ã¯ãªãç”»åƒã§ã€ä»Šå›ã®æ•°å€¤ã¯ç”»åƒã®ãƒˆãƒªãƒŸãƒ³ã‚°ä½ç½®ã«ã‚ãŸã‚Šã¾ã™ã€‚è¦‹ã¦ã„ã‚‹ã®ã¯ç”»åƒãªã®ã§ã€ãã‚‚ãã‚‚åŸå› 1ãŒç™ºç”Ÿã—ã¦ã„ã‚‹ã¨æ°—ä»˜ãã¾ã§ã«ã‹ãªã‚Šã®æ™‚é–“ãŒã‹ã‹ã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚

ã‚‚ã¯ã‚„ãªãœä»Šã•ã‚‰è§£æ±ºã§ããŸã®ã‹åˆ†ã‹ã‚Šã¾ã›ã‚“ãŒã€æ€¥ã«æ€ã„ä»˜ã„ãŸã®ã§è§£æ±ºã§ãã¾ã—ãŸã€‚


## å‚è€ƒ
- [tf.data.Dataset Â |Â  TensorFlow v2.11.0](https://www.tensorflow.org/api_docs/python/tf/data/Dataset)
- [æ©Ÿæ¢°å­¦ç¿’ã«ãŠã‘ã‚‹ãƒ©ãƒ³ãƒ€ãƒ ã‚·ãƒ¼ãƒ‰ã®ç ”ç©¶ - Qiita](https://qiita.com/si1242/items/d2f9195c08826d87d6ad#tensorflow%E3%81%AE%E3%82%B7%E3%83%BC%E3%83%89%E5%9B%BA%E5%AE%9A)
- [Tensorflow tf.data.Dataset API, dataset unzip function? - Stack Overflow](https://stackoverflow.com/questions/53641920/tensorflow-tf-data-dataset-api-dataset-unzip-function)
- [Subsequent calls to tf.data.Dataset.map() with seeded random operation give same random sequences. Â· Issue #35090 Â· tensorflow/tensorflow](https://github.com/tensorflow/tensorflow/issues/35090)